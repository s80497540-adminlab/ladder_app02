import { Button, CheckBox, ComboBox, LineEdit, ListView, TextEdit } from "std-widgets.slint";

// ---------- Data structs exposed to Rust ----------------------------

export struct BookLevel {
    price_main: string,
    price_pad: string,
    size_main: string,
    size_pad: string,
    depth_ratio: float,
    is_best: bool,
}

export struct TickerFeedRow {
    ticker: string,
    feed_on: bool,
    active: bool,
}

export struct Trade {
    ts: string,
    side: string,
    size: string,
    is_buy: bool,
}

export struct TfOption {
    label: string,
    secs: int,
}

export struct CandleRow {
    ts: string,
    open: string,
    high: string,
    low: string,
    close: string,
    volume: string,
}

export struct CandlePoint {
    x: float,
    w: float,
    open: float,
    high: float,
    low: float,
    close: float,
    is_up: bool,
    volume: float,   // normalized 0..1 volume
}

export struct AxisTick {
    pos: float,   // 0..1 (0=top/left, 1=bottom/right)
    label: string,
}

export struct DrawShape {
    id: int,
    kind: string,
    x1: float,
    y1: float,
    x2: float,
    y2: float,
    commands: string,
    label: string,
    is_preview: bool,
    selected: bool,
}

export struct DrawTick {
    x: float,
    y: float,
    label: string,
    is_preview: bool,
}

export struct HeatmapCell {
    x: float,
    y: float,
    w: float,
    h: float,
    color: color,
}

export struct Receipt {
    ts: string,
    ticker: string,
    side: string,
    kind: string,
    size: string,
    status: string,
    comment: string,
}

component ZeroPadText inherits Rectangle {
    in property <string> main;
    in property <string> pad;
    in property <color> main_color: #ffffff;
    in property <color> pad_color: #7aa8ff;
    in property <length> font_size: 12px;
    in property <length> pad_font_size: font_size - 3px;
    in property <string> font_family: "";

    width: main_text.preferred-width + pad_text.preferred-width;
    height: main_text.preferred-height;

    main_text := Text {
        x: 0px;
        y: 0px;
        text: main;
        color: main_color;
        font-size: font_size;
        font-family: font_family;
    }

    pad_text := Text {
        x: main_text.preferred-width;
        y: 0px;
        text: pad;
        color: pad_color;
        font-size: pad_font_size;
        font-family: font_family;
    }
}

component TickerBadge inherits Rectangle {
    in property <string> value;
    in property <length> font_size: 12px;
    in property <color> text_color: #e4ebff;
    in property <color> accent_color: #2a3852;
    in property <string> font_family: "";

    background: #0f1420;
    border-width: 1px;
    border-color: #2b3446;
    border-radius: 6px;
    clip: true;

    Rectangle {
        x: 1px;
        y: 1px;
        width: parent.width - 2px;
        height: 1px;
        background: #1a2232;
    }

    Rectangle {
        x: 0px;
        y: parent.height - 2px;
        width: parent.width;
        height: 2px;
        background: accent_color;
    }

    TextInput {
        x: 10px;
        y: 2px;
        width: parent.width - 20px;
        height: parent.height - 4px;
        text: root.value;
        read-only: true;
        single-line: true;
        color: text_color;
        font-size: font_size;
        font-family: font_family;
        selection-background-color: #2a3b63;
        selection-foreground-color: #ffffff;
    }
}

component TopBarLabel inherits Text {
    in property <length> label_font_size: 18px;
    in property <string> label_font_family: "Avenir Next";
    font-size: label_font_size;
    font-family: label_font_family;
}

component TopBarButton inherits Rectangle {
    in property <string> text;
    in property <bool> active: false;
    in property <bool> enabled: true;
    in property <length> font_size: 18px;
    in property <string> font_family: "Avenir Next";
    in property <color> text_color: #dfe7ff;
    in property <color> active_text_color: #f5f7ff;
    callback clicked;

    background: active ? #2b3550 : #1e2433;
    border-width: 1px;
    border-color: active ? #5a6aa0 : #2a3242;
    border-radius: 4px;
    opacity: enabled ? 1 : 0.5;

    Text {
        x: 8px;
        y: 0px;
        width: parent.width - 16px;
        height: parent.height;
        text: root.text;
        color: root.active ? root.active_text_color : root.text_color;
        font-size: root.font_size;
        font-family: root.font_family;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    TouchArea {
        enabled: root.enabled;
        clicked => { root.clicked(); }
    }
}

component TopBarCheck inherits Rectangle {
    in-out property <bool> checked;
    in property <string> text;
    in property <length> font_size: 18px;
    in property <string> font_family: "Avenir Next";
    in property <length> box_size: 14px;
    callback toggled(checked: bool);

    Rectangle {
        x: 0px;
        y: (parent.height - box_size) / 2;
        width: box_size;
        height: box_size;
        background: root.checked ? #3b70ff : #141a26;
        border-width: 1px;
        border-color: root.checked ? #6a8dff : #2c3547;
        border-radius: 3px;
    }

    TopBarLabel {
        x: box_size + 6px;
        y: 0px;
        width: parent.width - (box_size + 6px);
        height: parent.height;
        text: root.text;
        color: #d0d6e6;
        label_font_size: root.font_size;
        label_font_family: root.font_family;
        vertical-alignment: center;
    }

    TouchArea {
        clicked => {
            root.checked = !root.checked;
            root.toggled(root.checked);
        }
    }
}

component TopBarSelect inherits Rectangle {
    in property <[string]> model;
    in-out property <int> current_index: 0;
    in property <bool> enabled: true;
    in property <length> font_size: 18px;
    in property <string> font_family: "Avenir Next";
    in-out property <bool> open: false;
    callback selected(value: string);

    property <string> current_label:
        (current_index >= 0 && current_index < model.length) ? model[current_index] : "";

    background: #1e2433;
    border-width: 1px;
    border-color: #2a3242;
    border-radius: 4px;
    clip: false;
    opacity: enabled ? 1 : 0.5;

    TopBarLabel {
        x: 8px;
        y: 0px;
        width: parent.width - 22px;
        height: parent.height;
        text: root.current_label;
        color: #dfe7ff;
        label_font_size: root.font_size;
        label_font_family: root.font_family;
        vertical-alignment: center;
    }

    TopBarLabel {
        x: parent.width - 16px;
        y: 0px;
        width: 12px;
        height: parent.height;
        text: root.open ? "^" : "v";
        color: #9fb3d9;
        label_font_size: root.font_size;
        label_font_family: root.font_family;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    TouchArea {
        enabled: root.enabled;
        clicked => { root.open = !root.open; }
    }

    Rectangle {
        x: 0px;
        y: parent.height + 2px;
        width: parent.width;
        height: Math.min(220px, model.length * (font_size + 6px) + 8px);
        background: #0f1420;
        border-width: 1px;
        border-color: #2b3446;
        border-radius: 4px;
        visible: root.open;

        ListView {
            x: 6px;
            y: 6px;
            width: parent.width - 12px;
            height: parent.height - 12px;

            for option[i] in root.model : Rectangle {
                width: parent.width;
                height: font_size + 6px;
                background: i == root.current_index ? #1b2438 : #111725;

                TopBarLabel {
                    x: 6px;
                    y: 0px;
                    width: parent.width - 12px;
                    height: parent.height;
                    text: option;
                    color: #d6dcff;
                    label_font_size: root.font_size;
                    label_font_family: root.font_family;
                    vertical-alignment: center;
                }

                TouchArea {
                    clicked => {
                        root.current_index = i;
                        root.selected(option);
                        root.open = false;
                    }
                }
            }
        }
    }
}

// ---------- Orderbook panel with drag + richer rows + intensity -----

component OrderbookPanel inherits Rectangle {
    in-out property <[BookLevel]> bids;
    in-out property <[BookLevel]> asks;
    in property <string> title;
    in property <float> mid;
    in property <float> spread;
    in property <string> spread_main;
    in property <string> spread_pad;

    background: #202533;
    border-radius: 4px;
    border-width: 1px;
    border-color: #31384a;

    Rectangle {
        x: 0px;
        y: 0px;
        width: parent.width;
        height: 24px;
        background: #303545;

        Text {
            x: 6px;
            y: 4px;
            width: parent.width - 120px;
            height: 16px;
            text: title;
            color: #ffffff;
        }

        Rectangle {
            x: parent.width - 110px;
            y: 4px;
            width: 104px;
            height: 16px;
            border-radius: 8px;
            background: spread < mid * 0.0005
                ? #123922
                : (spread > mid * 0.0015 ? #45161c : #303545);

            HorizontalLayout {
                x: 4px;
                y: 1px;
                width: parent.width - 8px;
                height: parent.height - 2px;
                spacing: 2px;

                Text {
                    text: "Spr:";
                    color: #e0e0e0;
                    font-size: 10px;
                }

                ZeroPadText {
                    main: spread_main;
                    pad: spread_pad;
                    main_color: #e0e0e0;
                    pad_color: #7aa8ff;
                    font_size: 10px;
                }
            }
        }

        TouchArea {
            x: 0px;
            y: 0px;
            width: parent.width;
            height: parent.height;

            property <length> last_x;
            property <length> last_y;
            property <bool> dragging;

            pointer-event(event) => {
                if event.kind == PointerEventKind.down {
                    dragging = true;
                    last_x = self.mouse-x;
                    last_y = self.mouse-y;
                } else if event.kind == PointerEventKind.up {
                    dragging = false;
                } else if event.kind == PointerEventKind.move && dragging {
                    let dx = self.mouse-x - last_x;
                    let dy = self.mouse-y - last_y;

                    root.x = root.x + dx;
                    root.y = root.y + dy;

                    last_x = self.mouse-x;
                    last_y = self.mouse-y;
                }
            }
        }
    }

    Rectangle {
        x: 4px;
        y: 28px;
        width: (parent.width * 0.5) - 6px;
        height: parent.height - 32px;
        background: #10131a;
        border-radius: 2px;
        border-width: 1px;
        border-color: #222634;

        Text { x: 4px; y: 4px; text: "Bids"; color: #66ff66; }
        Text { x: 4px; y: 20px; text: "Price"; color: #88ff88; }
        Text { x: parent.width - 70px; y: 20px; text: "Size"; color: #88ff88; }

        ListView {
            x: 4px;
            y: 36px;
            width: parent.width - 8px;
            height: parent.height - 40px;

            for b in root.bids : Rectangle {
                width: parent.width;
                height: 18px;
                background: #10131a;
                border-width: b.is_best ? 1px : 0px;
                border-color: #a0ffb0;

                property <float> row_fade: 0.25 + (1.0 - (self.y / parent.height)) * 0.75;
                property <float> heat: b.depth_ratio * (2.0 - b.depth_ratio);

                Rectangle {
                    x: 0px;
                    y: 2px;
                    width: parent.width * heat;
                    height: parent.height - 4px;
                    background: #123922;
                    opacity: (0.12 + heat * 0.88) * row_fade;
                }

                ZeroPadText {
                    x: 4px;
                    y: 1px;
                    main: b.price_main;
                    pad: b.price_pad;
                    main_color: b.depth_ratio > 0.7 ? #ffffff : (b.depth_ratio > 0.3 ? #b0ffb0 : #80b080);
                    pad_color: #7aa8ff;
                    font_size: 12px;
                }

                ZeroPadText {
                    y: 1px;
                    main: b.size_main;
                    pad: b.size_pad;
                    main_color: b.depth_ratio > 0.7 ? #f0fff0 : (b.depth_ratio > 0.3 ? #e0ffe0 : #a0c0a0);
                    pad_color: #7aa8ff;
                    font_size: 12px;
                    x: parent.width - 4px - self.width;
                }
            }
        }
    }

    Rectangle {
        x: (parent.width * 0.5) + 2px;
        y: 28px;
        width: (parent.width * 0.5) - 6px;
        height: parent.height - 32px;
        background: #10131a;
        border-radius: 2px;
        border-width: 1px;
        border-color: #222634;

        Text { x: 4px; y: 4px; text: "Asks"; color: #ff6666; }
        Text { x: 4px; y: 20px; text: "Price"; color: #ffaaaa; }
        Text { x: parent.width - 70px; y: 20px; text: "Size"; color: #ffaaaa; }

        ListView {
            x: 4px;
            y: 36px;
            width: parent.width - 8px;
            height: parent.height - 40px;

            for a in root.asks : Rectangle {
                width: parent.width;
                height: 18px;
                background: #10131a;
                border-width: a.is_best ? 1px : 0px;
                border-color: #ffb0b0;

                property <float> row_fade: 0.25 + (1.0 - (self.y / parent.height)) * 0.75;
                property <float> heat: a.depth_ratio * a.depth_ratio;

                Rectangle {
                    width: parent.width * heat;
                    height: parent.height - 4px;
                    x: parent.width - self.width;
                    y: 2px;
                    background: #45161c;
                    opacity: (0.12 + heat * 0.88) * row_fade;
                }

                ZeroPadText {
                    x: 4px;
                    y: 1px;
                    main: a.price_main;
                    pad: a.price_pad;
                    main_color: a.depth_ratio > 0.7 ? #ffffff : (a.depth_ratio > 0.3 ? #ffd0d0 : #c08080);
                    pad_color: #7aa8ff;
                    font_size: 12px;
                }

                ZeroPadText {
                    y: 1px;
                    main: a.size_main;
                    pad: a.size_pad;
                    main_color: a.depth_ratio > 0.7 ? #ffeaea : (a.depth_ratio > 0.3 ? #ffdada : #c0a0a0);
                    pad_color: #7aa8ff;
                    font_size: 12px;
                    x: parent.width - 4px - self.width;
                }
            }
        }
    }
}

// ---------- Settings panel (movable) --------------------------------

component SettingsPanel inherits Rectangle {
    in-out property <string> wallet_address;
    in-out property <string> wallet_status;

    in-out property <string> network;
    in-out property <string> rpc_endpoint;

    in-out property <bool> auto_sign;
    in-out property <string> session_ttl_minutes;
    in-out property <string> signer_status;

    in-out property <string> last_error;

    callback connect_wallet();
    callback disconnect_wallet();
    callback refresh_status();

    callback select_network(net: string);
    callback apply_rpc(endpoint: string);

    callback toggle_auto_sign(enabled: bool);
    callback create_session(ttl_minutes: string);
    callback revoke_session();

    background: #202533;
    border-radius: 4px;
    border-width: 1px;
    border-color: #31384a;

    Rectangle {
        x: 0px; y: 0px; width: parent.width; height: 24px;
        background: #303545;

        Text { x: 6px; y: 4px; text: "Settings"; color: #ffffff; }

        TouchArea {
            x: 0px; y: 0px; width: parent.width; height: parent.height;

            property <length> last_x;
            property <length> last_y;
            property <bool> dragging;

            pointer-event(event) => {
                if event.kind == PointerEventKind.down {
                    dragging = true;
                    last_x = self.mouse-x;
                    last_y = self.mouse-y;
                } else if event.kind == PointerEventKind.up {
                    dragging = false;
                } else if event.kind == PointerEventKind.move && dragging {
                    let dx = self.mouse-x - last_x;
                    let dy = self.mouse-y - last_y;
                    root.x = root.x + dx;
                    root.y = root.y + dy;
                    last_x = self.mouse-x;
                    last_y = self.mouse-y;
                }
            }
        }
    }

    Rectangle {
        x: 6px;
        y: 28px;
        width: parent.width - 12px;
        height: parent.height - 34px;
        background: #10131a;
        border-radius: 3px;
        border-width: 1px;
        border-color: #222634;

        Text { x: 6px; y: 6px; text: "Wallet"; color: #ffffff; }

        Text { x: 6px; y: 26px; text: "Address:"; color: #aaaaaa; font-size: 10px; }
        LineEdit {
            x: 68px;
            y: 22px;
            width: parent.width - 74px;
            height: 20px;
            text <=> root.wallet_address;
        }

        Button { x: 6px;  y: 48px; text: "Connect";    clicked => { root.connect_wallet(); } }
        Button { x: 92px; y: 48px; text: "Disconnect"; clicked => { root.disconnect_wallet(); } }
        Button { x: 196px; y: 48px; text: "Refresh";   clicked => { root.refresh_status(); } }

        Text {
            x: 6px; y: 76px; width: parent.width - 12px;
            text: "Status: " + root.wallet_status;
            color: #c0c0c0; font-size: 10px;
        }

        Rectangle { x: 6px; y: 94px; width: parent.width - 12px; height: 1px; background: #222634; opacity: 0.8; }
        Text { x: 6px; y: 102px; text: "Network"; color: #ffffff; }

        Button { x: 6px;  y: 122px; text: "Mainnet"; clicked => { root.select_network("Mainnet"); } }
        Button { x: 92px; y: 122px; text: "Testnet"; clicked => { root.select_network("Testnet"); } }

        Text {
            x: 188px; y: 126px;
            text: "Selected: " + root.network;
            color: #c0c0c0; font-size: 10px;
        }

        Text { x: 6px; y: 150px; text: "RPC/Endpoint:"; color: #aaaaaa; font-size: 10px; }
        LineEdit {
            x: 92px; y: 146px;
            width: parent.width - 160px; height: 20px;
            text <=> root.rpc_endpoint;
        }
        Button {
            x: parent.width - 62px;
            y: 146px;
            text: "Apply";
            clicked => { root.apply_rpc(root.rpc_endpoint); }
        }

        Rectangle { x: 6px; y: 174px; width: parent.width - 12px; height: 1px; background: #222634; opacity: 0.8; }
        Text { x: 6px; y: 182px; text: "Signing"; color: #ffffff; }

        CheckBox {
            x: 6px; y: 202px;
            text: "Auto-sign (session)";
            checked <=> root.auto_sign;
            toggled => { root.toggle_auto_sign(self.checked); }
        }

        Text { x: 6px; y: 226px; text: "Session TTL (min):"; color: #aaaaaa; font-size: 10px; }
        LineEdit { x: 110px; y: 222px; width: 60px; height: 20px; text <=> root.session_ttl_minutes; }

        Button { x: 178px; y: 220px; text: "Create"; clicked => { root.create_session(root.session_ttl_minutes); } }
        Button { x: 252px; y: 220px; text: "Revoke"; clicked => { root.revoke_session(); } }

        Text {
            x: 6px; y: 248px; width: parent.width - 12px;
            text: "Signer: " + root.signer_status;
            color: #c0c0c0; font-size: 10px;
        }

        Text {
            x: 6px; y: 266px; width: parent.width - 12px;
            text: root.last_error;
            color: #ff8080; font-size: 10px;
        }
    }
}

// ---------- Micro depth panel (two-wall trough) ---------------------

component MicroDepthPanel inherits Rectangle {
    in-out property <[BookLevel]> bids;
    in-out property <[BookLevel]> asks;
    in property <float> imbalance;

    property <float> top_bid_ratio: bids.length > 0 ? bids[0].depth_ratio : 0.0;
    property <float> top_ask_ratio: asks.length > 0 ? asks[0].depth_ratio : 0.0;

    background: #11141d;
    border-radius: 3px;
    border-width: 1px;
    border-color: #262b38;

    Text { x: 4px; y: 2px; text: "Micro Depth"; color: #bbbbbb; font-size: 10px; }
    Text { x: parent.width - 80px; y: 2px; width: 76px; horizontal-alignment: right;
           text: "Imb: " + imbalance; color: #c0c0c0; font-size: 10px; }

    Rectangle {
        x: 4px;
        y: 16px;
        width: parent.width - 8px;
        height: parent.height - 20px;
        background: #151821;

        Rectangle { x: 0.5 * parent.width - 1px; y: 2px; width: 2px; height: parent.height - 4px;
                    background: #303545; opacity: 0.8; }

        Rectangle {
            x: 0px;
            width: 0.5 * parent.width;

            property <length> bar_height: 2px + (parent.height - 4px) * root.top_bid_ratio;
            y: parent.height - bar_height;
            height: bar_height;

            background: #1e5a2f;
            opacity: 0.2 + root.top_bid_ratio * 0.8;
        }

        Rectangle {
            x: 0.5 * parent.width;
            width: 0.5 * parent.width;

            property <length> bar_height: 2px + (parent.height - 4px) * root.top_ask_ratio;
            y: parent.height - bar_height;
            height: bar_height;

            background: #7a2a30;
            opacity: 0.2 + root.top_ask_ratio * 0.8;
        }
    }
}

// ---------- Candlestick chart (zoom + pan + cursor + wheel zoom) ----
// FIXED: no range loops + flush candles (pixel-edge snapping + 1px overlap)
component CandleChart inherits Rectangle {
    in property <bool> show_volume_bars;
    in property <[CandlePoint]> points;
    in property <float> mid_line_y;
    in property <[DrawShape]> drawings;
    in property <[DrawTick]> draw_ticks;
    in property <[HeatmapCell]> heatmap_cells;
    in property <bool> heatmap_enabled;
    in property <bool> advanced_mode;
    in property <string> draw_tool;
    in-out property <float> x_zoom;
    in-out property <float> y_zoom;
    in-out property <float> pan_x;
    in-out property <float> pan_y;
    in-out property <float> cursor_x;
    in-out property <float> cursor_y;

    callback draw_begin(x: float, y: float);
    callback draw_update(x: float, y: float);
    callback draw_end(x: float, y: float);
    callback draw_poly_sides_delta(delta: int);

    property <bool> draw_dragging: false;

    background: advanced_mode ? #0a0c14 : #0b0f16;
    clip: true;
    border-radius: 2px;
    border-width: 1px;
    border-color: advanced_mode ? #2a2f45 : #1c2230;

    Rectangle { x: 0px; width: parent.width; height: 1px; y: parent.height * 0.25; background: advanced_mode ? #1f2b3f : #1a202d; opacity: advanced_mode ? 0.55 : 0.35; }
    Rectangle { x: 0px; width: parent.width; height: 1px; y: parent.height * 0.5;  background: advanced_mode ? #1f2b3f : #1a202d; opacity: advanced_mode ? 0.55 : 0.35; }
    Rectangle { x: 0px; width: parent.width; height: 1px; y: parent.height * 0.75; background: advanced_mode ? #1f2b3f : #1a202d; opacity: advanced_mode ? 0.55 : 0.35; }

    Rectangle {
        x: 0px;
        width: parent.width;
        height: 1px;
        property <float> mid_z: Math.max(0.0, Math.min(1.0, mid_line_y + root.pan_y));
        y: mid_z * parent.height;
        background: advanced_mode ? #2b3d5e : #232a39;
        opacity: advanced_mode ? 0.85 : 0.7;
    }

    // Heatmap underlay
    for h in heatmap_cells : Rectangle {
        visible: root.heatmap_enabled;
        property <float> x0: Math.max(-0.2, h.x - h.w * 0.5);
        property <float> x1: Math.min(1.2, h.x + h.w * 0.5);
        property <float> y0: Math.max(-0.2, h.y - h.h * 0.5);
        property <float> y1: Math.min(1.2, h.y + h.h * 0.5);

        x: x0 * parent.width;
        y: y0 * parent.height;
        width: Math.max(1px, (x1 - x0) * parent.width);
        height: Math.max(1px, (y1 - y0) * parent.height);
        background: h.color;
    }

    // Volume bars (gapless via snapped edges)
    for cp in points : Rectangle {
        visible: root.show_volume_bars && ((x_n + w_n) > -0.2) && ((x_n - w_n) < 1.2);
        property <float> zx: Math.max(0.25, Math.min(8.0, root.x_zoom));

        property <float> x_n: 0.5 + (cp.x - 0.5) * zx + root.pan_x;
        property <float> w_n: cp.w * zx;

        property <float> left_f:  (x_n - w_n * 0.5) * (parent.width / 1px);
        property <float> right_f: (x_n + w_n * 0.5) * (parent.width / 1px);

        property <float> left_px:  Math.round(left_f);
        property <float> right_px: Math.round(right_f);

        x: left_px * 1px;
        width: (Math.max(1.0, (right_px - left_px)) + 1.0) * 1px; // +1px overlap kills cracks

        //visible: (x_n + w_n) > -0.2 && (x_n - w_n) < 1.2;

        y: parent.height - Math.max(1px, cp.volume * parent.height * 0.25);
        height: Math.max(1px, cp.volume * parent.height * 0.25);
        background: #303545;
        opacity: 0.35;
    }

    // Candles (slot is snapped + overlapped; body fills full slot => visually flush)
    for cp in points : Rectangle {
        property <float> zx: Math.max(0.25, Math.min(8.0, root.x_zoom));
        property <float> zy: Math.max(0.25, Math.min(8.0, root.y_zoom));

        property <float> x_n: 0.5 + (cp.x - 0.5) * zx + root.pan_x;
        property <float> w_n: cp.w * zx;

        property <float> left_f:  (x_n - w_n * 0.5) * (parent.width / 1px);
        property <float> right_f: (x_n + w_n * 0.5) * (parent.width / 1px);

        property <float> left_px:  Math.round(left_f);
        property <float> right_px: Math.round(right_f);

        property <float> open_z:  Math.max(0.0, Math.min(1.0, 0.5 + (cp.open  - 0.5) * zy + root.pan_y));
        property <float> high_z:  Math.max(0.0, Math.min(1.0, 0.5 + (cp.high  - 0.5) * zy + root.pan_y));
        property <float> low_z:   Math.max(0.0, Math.min(1.0, 0.5 + (cp.low   - 0.5) * zy + root.pan_y));
        property <float> close_z: Math.max(0.0, Math.min(1.0, 0.5 + (cp.close - 0.5) * zy + root.pan_y));

        x: left_px * 1px;
        width: (Math.max(2.0, (right_px - left_px)) + 1.0) * 1px; // +1px overlap
        y: 0px;
        height: parent.height;

        visible: (x_n + w_n) > -0.2 && (x_n - w_n) < 1.2;

        // Wick stays thin and centered
        Rectangle {
            x: parent.width * 0.5 - 0.5px;
            width: 1px;
            y: high_z * parent.height;
            height: Math.max(1px, (low_z - high_z) * parent.height);
            background: cp.is_up ? #66cc88 : #cc6677;
            opacity: 0.95;
        }

        // BODY FILLS THE WHOLE SLOT
        Rectangle {
            x: 0px;
            width: parent.width;
            y: Math.min(open_z, close_z) * parent.height;
            height: Math.max(1px, (Math.max(open_z, close_z) - Math.min(open_z, close_z)) * parent.height);
            background: cp.is_up ? #44aa66 : #aa4455;
            opacity: 0.95;
        }
    }

    // Drawn rectangles (zones)
    for d in drawings : Rectangle {
        visible: d.kind == "Rect";
        property <float> x0: Math.min(d.x1, d.x2);
        property <float> x1: Math.max(d.x1, d.x2);
        property <float> y0: Math.min(d.y1, d.y2);
        property <float> y1: Math.max(d.y1, d.y2);

        x: x0 * parent.width;
        y: y0 * parent.height;
        width: Math.max(2px, (x1 - x0) * parent.width);
        height: Math.max(2px, (y1 - y0) * parent.height);
        background: d.is_preview ? #1e2d4666 : (d.selected ? #2b3a4f55 : #1e2d4633);
        border-width: 1px;
        border-color: d.selected ? #f0d66a : #6ab0ff;
        border-radius: 2px;
    }

    // Drawn polygons + pencil paths
    for d in drawings : Path {
        visible: d.commands != "";
        x: 0px;
        y: 0px;
        width: parent.width;
        height: parent.height;
        viewbox-x: 0;
        viewbox-y: 0;
        viewbox-width: 1;
        viewbox-height: 1;
        commands: d.commands;
        stroke: d.selected ? #f0d66a : (d.kind == "Pencil" ? #88ccff : #6ab0ff);
        stroke-width: d.selected ? 2px : 1px;
        fill: d.kind == "Poly" ? (d.is_preview ? #2b3a4f55 : #2b3a4f33) : #00000000;
        opacity: d.is_preview ? 0.6 : 0.9;
    }

    // Drawn lines + rulers
    for d in drawings : Path {
        visible: d.kind == "Line" || d.kind == "Ruler";
        x: 0px;
        y: 0px;
        width: parent.width;
        height: parent.height;
        viewbox-x: 0;
        viewbox-y: 0;
        viewbox-width: 1;
        viewbox-height: 1;
        stroke: d.selected ? #f0d66a : (d.kind == "Ruler" ? #6ab0ff : #ffaa66);
        stroke-width: d.selected ? 2px : 1px;
        fill: #00000000;
        opacity: d.is_preview ? 0.6 : 0.9;

        MoveTo { x: d.x1; y: d.y1; }
        LineTo { x: d.x2; y: d.y2; }
    }

    // Ruler ticks (tape measure)
    for t in draw_ticks : Rectangle {
        property <length> tick_x: Math.max(2px, Math.min(parent.width - 8px, (t.x * parent.width) - 3px));
        property <length> tick_y: Math.max(2px, Math.min(parent.height - 2px, (t.y * parent.height)));
        x: tick_x;
        y: tick_y;
        width: 6px;
        height: 1px;
        background: #6ab0ff;
        opacity: t.is_preview ? 0.5 : 0.9;
    }

    for t in draw_ticks : Rectangle {
        visible: t.label != "";
        property <length> label_w: 70px;
        property <length> lx: Math.max(4px, Math.min(parent.width - label_w - 4px, (t.x * parent.width) + 6px));
        property <length> ly: Math.max(2px, Math.min(parent.height - 14px, (t.y * parent.height) - 6px));
        x: lx;
        y: ly;
        width: label_w;
        height: 12px;
        background: #0f1420cc;
        border-width: 1px;
        border-color: #38435a;
        border-radius: 2px;
        opacity: t.is_preview ? 0.6 : 0.95;

        Text { x: 3px; y: 0px; text: t.label; color: #d7e8ff; font-size: 8px; }
    }

    // Ruler labels
    for d in drawings : Rectangle {
        visible: d.label != "";
        property <length> label_w: 190px;
        x: Math.max(4px, Math.min(parent.width - label_w - 4px, (d.x2 * parent.width) + 6px));
        y: Math.max(4px, Math.min(parent.height - 18px, (d.y2 * parent.height) - 18px));
        width: label_w;
        height: 16px;
        background: #0f1420cc;
        border-width: 1px;
        border-color: #38435a;
        border-radius: 3px;

        Text { x: 4px; y: 1px; text: d.label; color: #d7e8ff; font-size: 9px; }
    }

    Rectangle {
        x: Math.max(0px, Math.min(parent.width - 1px, root.cursor_x * parent.width));
        y: 0px;
        width: 1px;
        height: parent.height;
        background: advanced_mode ? #2e3b52 : #303545;
        opacity: advanced_mode ? 0.6 : 0.45;
    }

    Rectangle {
        x: 0px;
        y: Math.max(0px, Math.min(parent.height - 1px, root.cursor_y * parent.height));
        width: parent.width;
        height: 1px;
        background: advanced_mode ? #2e3b52 : #303545;
        opacity: advanced_mode ? 0.6 : 0.45;
    }

    TouchArea {
        x: 0px;
        y: 0px;
        width: parent.width;
        height: parent.height;

        property <length> last_x;
        property <length> last_y;
        property <bool> dragging;

        pointer-event(event) => {
            let local_x = self.absolute-position.x + self.mouse-x - root.absolute-position.x;
            let local_y = self.absolute-position.y + self.mouse-y - root.absolute-position.y;
            root.cursor_x = Math.max(0.0, Math.min(1.0, local_x / parent.width));
            root.cursor_y = Math.max(0.0, Math.min(1.0, local_y / parent.height));
            let x_n = root.cursor_x;
            let y_n = root.cursor_y;

            if root.draw_tool == "Pan" {
                if event.kind == PointerEventKind.down {
                    dragging = true;
                    root.draw_dragging = false;
                    last_x = self.mouse-x;
                    last_y = self.mouse-y;
                } else if event.kind == PointerEventKind.up {
                    dragging = false;
                    root.draw_dragging = false;
                } else if event.kind == PointerEventKind.move && dragging {
                    let dx = (self.mouse-x - last_x) / parent.width;
                    let dy = (self.mouse-y - last_y) / parent.height;

                    root.pan_x = Math.max(-2.0, Math.min(2.0, root.pan_x + dx));
                    root.pan_y = Math.max(-1.0, Math.min(1.0, root.pan_y + dy));

                    last_x = self.mouse-x;
                    last_y = self.mouse-y;
                }
            } else {
                if event.kind == PointerEventKind.down {
                    dragging = true;
                    root.draw_dragging = true;
                    draw_focus.focus();
                    root.draw_begin(x_n, y_n);
                } else if event.kind == PointerEventKind.up {
                    if dragging {
                        root.draw_end(x_n, y_n);
                    }
                    dragging = false;
                    root.draw_dragging = false;
                } else if event.kind == PointerEventKind.move && dragging {
                    root.draw_update(x_n, y_n);
                }
            }
        }

        scroll-event(event) => {
            let local_x = self.absolute-position.x + self.mouse-x - root.absolute-position.x;
            let local_y = self.absolute-position.y + self.mouse-y - root.absolute-position.y;
            root.cursor_x = Math.max(0.0, Math.min(1.0, local_x / parent.width));
            root.cursor_y = Math.max(0.0, Math.min(1.0, local_y / parent.height));

            let dy = event.delta-y;
            let is_shift = event.modifiers.shift;
            let is_ctrl  = event.modifiers.control;

            let dir  = dy < 0px ? 1.0 : -1.0;
            let step = is_ctrl ? 0.05 : 0.25;

            if is_shift {
                let old_z = Math.max(0.25, Math.min(8.0, root.x_zoom));
                let cx = root.cursor_x;
                let px = root.pan_x;

                let xw = 0.5 + (cx - 0.5 - px) / old_z;

                let new_z = Math.max(0.25, Math.min(8.0, old_z + dir * step));
                root.x_zoom = new_z;

                let px2 = cx - 0.5 - (xw - 0.5) * new_z;
                root.pan_x = Math.max(-2.0, Math.min(2.0, px2));
            } else {
                let old_z = Math.max(0.25, Math.min(8.0, root.y_zoom));
                let cy = root.cursor_y;
                let py = root.pan_y;
                let mid = root.mid_line_y;

                let yw = mid + (cy - mid - py) / old_z;

                let new_z = Math.max(0.25, Math.min(8.0, old_z + dir * step));
                root.y_zoom = new_z;

                let py2 = cy - mid - (yw - mid) * new_z;
                root.pan_y = Math.max(-1.0, Math.min(1.0, py2));
            }

            EventResult.accept
        }
    }

    draw_focus := FocusScope {
        key-pressed(event) => {
            if root.draw_tool == "Poly" && root.draw_dragging {
                if event.text == Key.UpArrow {
                    root.draw_poly_sides_delta(1);
                    return accept;
                } else if event.text == Key.DownArrow {
                    root.draw_poly_sides_delta(-1);
                    return accept;
                }
            }
            return reject;
        }
    }
}


// ---------- Tiny PnL-style sparkline --------------------------------

component PnLSparkline inherits Rectangle {
    in property <[CandlePoint]> points;
    background: #00000000;

    for cp in points : Rectangle {
        x: cp.x * parent.width;
        width: 2px;
        y: cp.close * parent.height;
        height: 2px;
        background: cp.is_up ? #80ff80 : #ff8080;
    }
}

// ---------- Popout chart panel (draggable + resizable) --------------

component ChartPopoutPanel inherits Rectangle {
    in-out property <bool> open;
    in-out property <length> px;
    in-out property <length> py;
    in-out property <length> pw;
    in-out property <length> ph;

    in property <[CandlePoint]> points;
    in property <float> mid_line_y;
    in property <[DrawShape]> drawings;
    in property <[DrawTick]> draw_ticks;
    in property <[HeatmapCell]> heatmap_cells;
    in property <bool> heatmap_enabled;
    in property <bool> advanced_mode;
    in property <string> draw_tool;

    in-out property <float> x_zoom;
    in-out property <float> y_zoom;
    in-out property <float> pan_x;
    in-out property <float> pan_y;
    in-out property <float> cursor_x;
    in-out property <float> cursor_y;

    in property <string> title;

    callback draw_begin(x: float, y: float);
    callback draw_update(x: float, y: float);
    callback draw_end(x: float, y: float);
    callback draw_poly_sides_delta(delta: int);

    x: px;
    y: py;
    width: pw;
    height: ph;

    visible: open;

    background: advanced_mode ? #0b0f17 : #202533;
    border-radius: 6px;
    border-width: 1px;
    border-color: advanced_mode ? #3a3f55 : #31384a;

    Rectangle {
        x: 0px; y: 0px; width: parent.width; height: 26px;
        background: advanced_mode ? #1b2031 : #303545;

        Text { x: 8px; y: 5px; text: title; color: advanced_mode ? #f5e9ff : #ffffff; }

        Button {
            x: parent.width - 54px; y: 3px; width: 48px; height: 20px;
            text: "Close";
            clicked => { root.open = false; }
        }

        TouchArea {
            x: 0px; y: 0px; width: parent.width - 60px; height: parent.height;

            property <length> last_x;
            property <length> last_y;
            property <bool> dragging;

            pointer-event(event) => {
                if event.kind == PointerEventKind.down {
                    dragging = true;
                    last_x = self.mouse-x;
                    last_y = self.mouse-y;
                } else if event.kind == PointerEventKind.up {
                    dragging = false;
                } else if event.kind == PointerEventKind.move && dragging {
                    let dx = self.mouse-x - last_x;
                    let dy = self.mouse-y - last_y;

                    root.px = Math.max(0px, root.px + dx);
                    root.py = Math.max(40px, root.py + dy);

                    last_x = self.mouse-x;
                    last_y = self.mouse-y;
                }
            }
        }
    }

    Rectangle {
        x: 6px;
        y: 32px;
        width: parent.width - 12px;
        height: parent.height - 38px;
        background: #0b0f16;
        border-radius: 4px;
        border-width: 1px;
        border-color: #1c2230;

        CandleChart {
            x: 6px;
            y: 6px;
            width: parent.width - 12px;
            height: parent.height - 12px;

            points: root.points;
            mid_line_y: root.mid_line_y;
            drawings: root.drawings;
            draw_ticks: root.draw_ticks;
            heatmap_cells: root.heatmap_cells;
            heatmap_enabled: root.heatmap_enabled;
            advanced_mode: root.advanced_mode;
            draw_tool: root.draw_tool;

            x_zoom <=> root.x_zoom;
            y_zoom <=> root.y_zoom;
            pan_x <=> root.pan_x;
            pan_y <=> root.pan_y;
            cursor_x <=> root.cursor_x;
            cursor_y <=> root.cursor_y;

            draw_begin(x, y) => { root.draw_begin(x, y); }
            draw_update(x, y) => { root.draw_update(x, y); }
            draw_end(x, y) => { root.draw_end(x, y); }
            draw_poly_sides_delta(delta) => { root.draw_poly_sides_delta(delta); }
        }
    }

    Rectangle {
        x: parent.width - 14px;
        y: parent.height - 14px;
        width: 12px;
        height: 12px;
        background: #7070ff;
        opacity: 0.7;
        border-radius: 2px;

        TouchArea {
            x: -8px; y: -8px; width: 28px; height: 28px;

            property <length> start_w;
            property <length> start_h;
            property <length> last_x;
            property <length> last_y;
            property <bool> resizing;

            pointer-event(event) => {
                if event.kind == PointerEventKind.down {
                    resizing = true;
                    start_w = root.pw;
                    start_h = root.ph;
                    last_x = self.mouse-x;
                    last_y = self.mouse-y;
                } else if event.kind == PointerEventKind.up {
                    resizing = false;
                } else if event.kind == PointerEventKind.move && resizing {
                    let dx = self.mouse-x - last_x;
                    let dy = self.mouse-y - last_y;

                    let nw = start_w + dx;
                    let nh = start_h + dy;

                    root.pw = Math.max(420px, Math.min(1100px, nw));
                    root.ph = Math.max(260px, Math.min(900px, nh));
                }
            }
        }
    }
}

// ---------- Main window component -----------------------------------

export component AppWindow inherits Window {
    preferred-width: 1600px;
    preferred-height: 1000px;
    min-width: 1200px;
    min-height: 800px;
    max-width: 4000px;
    max-height: 3000px;
    title: "Ladder App 02";

    // TF dropdown backing data ---
    in-out property <[string]> tf_labels: [
        "1s","5s","15s","30s","60s",
        "120s","180s","300s",
        "10m","15m","30m",
        "1h","2h","4h","8h",
        "1d","1w"
    ];

    in-out property <[int]> tf_seconds: [
        1,5,15,30,60,
        120,180,300,
        600,900,1800,
        3600,7200,14400,28800,
        86400,604800
    ];

    in-out property <int> tf_selected: 4; // default "60s"

    property <float> topbar_scale: 1.5;
    property <string> topbar_font: "Avenir Next";
    property <length> topbar_font_size: 12px * topbar_scale;
    property <length> topbar_font_size_small: 10px * topbar_scale;
    property <length> topbar_y: 108px;
    property <length> topbar_h: 110px;
    property <length> topbar_gap: 4px;
    property <length> secondbar_h: 70px;
    property <length> secondbar_gap: 6px;
    property <length> secondbar_y: topbar_y + topbar_h + topbar_gap;
    property <length> chart_top_y: secondbar_y + secondbar_h + secondbar_gap;

    // Persisted panel positions (for phase-1 persistence)
    in-out property <length> orderbook_x: 16px;
    in-out property <length> orderbook_y: 80px;
    in-out property <length> settings_x: 392px;
    in-out property <length> settings_y: 80px;

    // ---- app-wide scroll state ----
    in-out property <float> ui_scroll_x_px: 0.0;
    in-out property <float> ui_scroll_y_px: 0.0;

    in-out property <float> ui_content_w_px: 1800.0;
    in-out property <float> ui_content_h_px: 1050.0;

    in-out property <string> mode;
    in-out property <string> time_mode;

    in-out property <bool> show_depth;
    in-out property <bool> show_ladders;
    in-out property <bool> show_trades;
    in-out property <bool> show_volume;

    in-out property <string> trade_side;
    in-out property <float> trade_size;
    in-out property <float> trade_leverage;

    in-out property <bool> trade_real_mode: false;

    in-out property <bool> trade_real_armed: false;
    in-out property <string> trade_real_arm_status: "NOT ARMED";
    in-out property <string> trade_real_arm_phrase: "";

    in-out property <string> bot_signal;
    in-out property <float> bot_size;
    in-out property <string> bot_comment;
    in-out property <bool> bot_auto_trade;

    in-out property <float> balance_usdc;
    in-out property <float> balance_pnl;

    in-out property <int> candle_tf_secs;
    in-out property <int> candle_window_minutes;
    in-out property <string> candle_price_mode: "Mid";

    in-out property <string> script_text;
    in-out property <string> script_error;

    in-out property <string> data_range;
    in-out property <string> current_ticker;
    in-out property <string> ticker_input: "ETH-USD";
    in-out property <int> market_poll_secs: 5;
    in-out property <bool> tickers_dropdown_open: false;

    in-out property <float> mid_price;
    in-out property <float> best_bid;
    in-out property <float> best_ask;
    in-out property <float> spread;
    in-out property <float> imbalance;
    in-out property <string> mid_price_main;
    in-out property <string> mid_price_pad;
    in-out property <string> best_bid_main;
    in-out property <string> best_bid_pad;
    in-out property <string> best_ask_main;
    in-out property <string> best_ask_pad;
    in-out property <string> spread_main;
    in-out property <string> spread_pad;
    in-out property <string> current_price_main;
    in-out property <string> current_price_pad;
    in-out property <string> mark_price_main;
    in-out property <string> mark_price_pad;
    in-out property <string> oracle_price_main;
    in-out property <string> oracle_price_pad;
    in-out property <string> last_price_main;
    in-out property <string> last_price_pad;

    in-out property <[BookLevel]> bids;
    in-out property <[BookLevel]> asks;
    in-out property <[TickerFeedRow]> ticker_feed_rows;
    in-out property <[Trade]> recent_trades;
    in-out property <[CandleRow]> candles;
    in-out property <[CandlePoint]> candle_points;
    in-out property <[AxisTick]> price_ticks;
    in-out property <[AxisTick]> time_ticks;
    in-out property <[DrawShape]> drawings;
    in-out property <[DrawTick]> draw_ticks;
    in-out property <[HeatmapCell]> heatmap_cells;
    in-out property <[Receipt]> receipts;

    in-out property <float> candle_midline;
    in-out property <string> axis_price_unit: "";
    in-out property <string> last_move;
    in-out property <int> dom_depth_levels;
    in-out property <bool> render_all_candles: false;
    in-out property <bool> feed_enabled: false;
    in-out property <bool> chart_enabled: false;
    in-out property <bool> history_valve_open: false;
    in-out property <bool> session_recording: true;
    in-out property <string> candle_feed_status: "";
    in-out property <string> history_status: "";
    in-out property <string> perf_status: "";
    in-out property <float> perf_load: 0.0;
    in-out property <bool> perf_healthy: true;
    in-out property <string> daemon_status: "";
    in-out property <bool> daemon_active: false;

    in-out property <float> chart_x_zoom: 1.0;
    in-out property <float> chart_y_zoom: 1.0;

    in-out property <float> chart_pan_x: 0.0;
    in-out property <float> chart_pan_y: 0.0;
    in-out property <float> chart_cursor_x: 0.5;
    in-out property <float> chart_cursor_y: 0.5;

    in-out property <length> inline_chart_height: 260px;
    in-out property <bool> is_fullscreen: false;

    in-out property <[string]> draw_tools: ["Pan", "Line", "Rect", "Ruler", "Poly", "Pencil"];
    in-out property <string> draw_tool: "Pan";
    in-out property <int> draw_selected_id: -1;
    in-out property <string> chart_view_mode: "Chart";
    in-out property <bool> heatmap_enabled: false;
    in-out property <bool> chart_sidebar_open: false;

    in-out property <bool> chart_popout_open: false;
    in-out property <length> chart_popout_x: 80px;
    in-out property <length> chart_popout_y: 240px;
    in-out property <length> chart_popout_w: 760px;
    in-out property <length> chart_popout_h: 440px;

    in-out property <string> current_time;
    in-out property <string> order_message;

    in-out property <string> settings_wallet_address;
    in-out property <string> settings_wallet_status;
    in-out property <string> settings_network: "Testnet";
    in-out property <string> settings_rpc_endpoint;
    in-out property <bool>   settings_auto_sign: false;
    in-out property <string> settings_session_ttl_minutes: "30";
    in-out property <string> settings_signer_status;
    in-out property <string> settings_last_error;

    callback ticker_changed(new_ticker: string);
    callback mode_changed(new_mode: string);
    callback time_mode_changed(new_time_mode: string);
    callback feed_enabled_changed(enabled: bool);
    callback chart_enabled_changed(enabled: bool);
    callback depth_panel_changed(enabled: bool);
    callback trades_panel_changed(enabled: bool);
    callback volume_panel_changed(enabled: bool);
    callback candle_tf_changed(new_tf: int);
    callback candle_window_changed(new_window: int);
    callback candle_price_mode_changed(new_mode: string);
    callback dom_depth_changed(new_depth: int);
    callback render_mode_changed(full: bool);
    callback history_valve_changed(open: bool);
    callback session_recording_changed(enabled: bool);
    callback close_and_save_requested();
    callback draw_tool_changed(tool: string);
    callback draw_begin(x: float, y: float);
    callback draw_update(x: float, y: float);
    callback draw_end(x: float, y: float);
    callback draw_poly_sides_delta(delta: int);
    callback drawing_selected(id: int);
    callback drawing_delete(id: int);
    callback drawing_clear_all();
    callback chart_view_mode_changed(mode: string);
    callback heatmap_enabled_changed(enabled: bool);
    callback market_poll_adjust(delta: int);
    callback ticker_feed_toggled(ticker: string, enabled: bool);

    callback send_order();
    callback reload_data();
    callback run_script();
    callback deposit(amount: float);
    callback withdraw(amount: float);
    callback stretch_to_viewport();
    callback fullscreen_toggle(state: bool);

    callback settings_connect_wallet();
    callback settings_disconnect_wallet();
    callback settings_refresh_status();
    callback settings_select_network(net: string);
    callback settings_apply_rpc(endpoint: string);
    callback settings_toggle_auto_sign(enabled: bool);
    callback settings_create_session(ttl_minutes: string);
    callback settings_revoke_session();

    callback trade_real_mode_toggled(enabled: bool);

    callback arm_real_request(phrase: string);
    callback disarm_real();

    // --------- VIEWPORT (fixed) + WORKSPACE (scrollable) -------------
    viewport := Rectangle {
        x: 0px;
        y: 0px;
        width: parent.width;
        height: parent.height;
        background: #151821;

        property <float> viewport_w_px: parent.width / 1px;
        property <float> viewport_h_px: parent.height / 1px;

        property <float> content_w_px: Math.max(root.ui_content_w_px, viewport_w_px);
        property <float> content_h_px: Math.max(root.ui_content_h_px, viewport_h_px);

        property <float> max_scroll_x: Math.max(0.0, content_w_px - viewport_w_px);
        property <float> max_scroll_y: Math.max(0.0, content_h_px - viewport_h_px);

        property <float> sx: Math.max(0.0, Math.min(max_scroll_x, root.ui_scroll_x_px));
        property <float> sy: Math.max(0.0, Math.min(max_scroll_y, root.ui_scroll_y_px));

        TouchArea {
            x: 0px;
            y: 0px;
            width: parent.width;
            height: parent.height;

            pointer-event(event) => { EventResult.reject }

            scroll-event(event) => {
                let dx0 = event.delta-x / 1px;
                let dy0 = event.delta-y / 1px;

                let use_shift_h = event.modifiers.shift && Math.abs(dx0) < 0.01;
                let dx = use_shift_h ? dy0 : dx0;
                let dy = use_shift_h ? 0.0 : dy0;

                let boost = 2.0;
                root.ui_scroll_x_px = Math.max(0.0, Math.min(viewport.max_scroll_x, root.ui_scroll_x_px + dx * boost));
                root.ui_scroll_y_px = Math.max(0.0, Math.min(viewport.max_scroll_y, root.ui_scroll_y_px + dy * boost));

                EventResult.accept
            }
        }

        Rectangle {
            x: -(sx * 1px);
            y: -(sy * 1px);
            width: content_w_px * 1px;
            height: content_h_px * 1px;
            background: #151821;

            Rectangle {
                x: 0px;
                y: 0px;
                width: parent.width;
                height: 40px;
                background: #1c202b;

                Text {
                    x: 8px;
                    y: 6px;
                    width: parent.width - 640px;
                    height: 28px;
                    text:
                        "Ticker: " + current_ticker
                        + "  | Mode: " + mode
                        + "  | Time: " + time_mode
                        + "  | Range: " + data_range
                        + "  | Now: " + current_time;
                    color: #e0e0e0;
                }
                Button {
                    x: parent.width - 600px;
                    y: 6px;
                    width: 76px;
                    height: 20px;
                    text: root.session_recording ? "Sess: On" : "Sess: Off";
                    clicked => {
                        root.session_recording = !root.session_recording;
                        root.session_recording_changed(root.session_recording);
                    }
                }
                Button {
                    x: parent.width - 680px;
                    y: 6px;
                    width: 72px;
                    height: 20px;
                    text: "Close";
                    clicked => { root.close_and_save_requested(); }
                }
                Button {
                    x: parent.width - 520px;
                    y: 6px;
                    width: 72px;
                    height: 20px;
                    text: root.history_valve_open ? "Hist: On" : "Hist: Off";
                    clicked => {
                        root.history_valve_open = !root.history_valve_open;
                        root.history_valve_changed(root.history_valve_open);
                    }
                }
                Text {
                    x: parent.width - 440px;
                    y: 6px;
                    width: 432px;
                    height: 28px;
                    text: candle_feed_status;
                    color: #a0a0a0;
                    horizontal-alignment: right;
                    font-size: 10px;
                }
                Text {
                    x: parent.width - 440px;
                    y: 20px;
                    width: 432px;
                    height: 16px;
                    text: history_status;
                    color: #a0c0ff;
                    horizontal-alignment: right;
                    font-size: 9px;
                    visible: history_status != "";
                }
            }

            Rectangle {
                x: 0px;
                y: 44px;
                width: parent.width;
                height: 60px;
                background: #1a1e27;

                property <color> mid_text_color: root.last_move == "up"
                    ? #80ff80
                    : (root.last_move == "down" ? #ff8080 : #c0c0c0);

                property <string> mid_move_symbol: root.last_move == "up"
                    ? ""
                    : (root.last_move == "down" ? "" : "");

                Text { x: 8px; y: 4px; text: "Balances  USDC: " + balance_usdc + "   PnL: " + balance_pnl; color: #d0e080; }

                HorizontalLayout {
                    x: 8px;
                    y: 26px;
                    width: parent.width - 16px;
                    height: 18px;
                    spacing: 6px;

                    Text { text: "Mid:"; color: mid_text_color; font-size: 12px; }
                    ZeroPadText { main: root.mid_price_main; pad: root.mid_price_pad; main_color: mid_text_color; pad_color: #7aa8ff; font_size: 12px; }
                    Text { text: mid_move_symbol; color: mid_text_color; font-size: 12px; }
                    Text { text: "Bid:"; color: mid_text_color; font-size: 12px; }
                    ZeroPadText { main: root.best_bid_main; pad: root.best_bid_pad; main_color: mid_text_color; pad_color: #7aa8ff; font_size: 12px; }
                    Text { text: "Ask:"; color: mid_text_color; font-size: 12px; }
                    ZeroPadText { main: root.best_ask_main; pad: root.best_ask_pad; main_color: mid_text_color; pad_color: #7aa8ff; font_size: 12px; }
                    Text { text: "Spread:"; color: mid_text_color; font-size: 12px; }
                    ZeroPadText { main: root.spread_main; pad: root.spread_pad; main_color: mid_text_color; pad_color: #7aa8ff; font_size: 12px; }
                    Text { text: "Imb:"; color: mid_text_color; font-size: 12px; }
                    Text { text: imbalance; color: mid_text_color; font-size: 12px; }
                }

                Text {
                    x: parent.width - 520px;
                    y: 8px;
                    width: 150px;
                    height: 18px;
                    text: daemon_status;
                    color: daemon_active ? #86ff86 : #ffb0b0;
                    font-size: 9px;
                    horizontal-alignment: right;
                }

                Rectangle {
                    x: parent.width - 360px;
                    y: 8px;
                    width: 180px;
                    height: 18px;
                    background: #151821;
                    border-radius: 3px;
                    border-width: 1px;
                    border-color: #2a3040;

                    Text {
                        x: 6px;
                        y: 2px;
                        width: parent.width - 12px;
                        height: parent.height - 4px;
                        text: perf_status;
                        color: perf_healthy ? #86ff86 : #ffb0b0;
                        font-size: 10px;
                    }

                    Rectangle {
                        x: 4px;
                        y: 14px;
                        width: (parent.width - 8px) * perf_load;
                        height: 2px;
                        background: perf_healthy ? #3aa24b : #c44b4b;
                    }
                }

                PnLSparkline { x: parent.width - 170px; y: 10px; width: 160px; height: 40px; points <=> root.candle_points; }
            }

            Rectangle {
                x: 0px;
                y: root.topbar_y;
                width: parent.width;
                height: root.topbar_h;
                background: #181b24;

                property <length> row1_y: 4px * root.topbar_scale;
                property <length> row1_text_y: 6px * root.topbar_scale;
                property <length> row2_y: 30px * root.topbar_scale;
                property <length> row2_text_y: 32px * root.topbar_scale;
                property <length> btn_h: 20px * root.topbar_scale;
                property <length> zoom_btn_h: 18px * root.topbar_scale;
                property <length> slider_h: 10px * root.topbar_scale;
                property <length> slider_y: row2_y + 4px * root.topbar_scale;
                property <length> font_main: root.topbar_font_size;
                property <length> font_small: root.topbar_font_size_small;

                TopBarLabel { x: 8px; y: row1_text_y; text: "Ticker:"; color: #cccccc; label_font_size: font_main; label_font_family: root.topbar_font; }

                TopBarButton {
                    x: 70px; y: row1_y; width: 70px; height: btn_h;
                    text: root.tickers_dropdown_open ? "List " : "List ";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => { root.tickers_dropdown_open = !root.tickers_dropdown_open; }
                }

                TickerBadge {
                    x: 146px;
                    y: row1_y;
                    width: 220px;
                    height: btn_h;
                    value: root.ticker_input;
                    font_size: font_main;
                    font_family: root.topbar_font;
                }

                TopBarLabel { x: 518px; y: row1_text_y; text: "Mode:"; color: #cccccc; label_font_size: font_main; label_font_family: root.topbar_font; }
                TopBarButton {
                    x: 568px; y: row1_y; width: 56px; height: btn_h;
                    text: "Live";
                    active: root.mode == "Live";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => { root.mode_changed("Live"); }
                }
                TopBarButton {
                    x: 628px; y: row1_y; width: 76px; height: btn_h;
                    text: "Replay";
                    active: root.mode == "Replay";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => { root.mode_changed("Replay"); }
                }

                TopBarLabel { x: 718px; y: row1_text_y; text: "Time:"; color: #cccccc; label_font_size: font_main; label_font_family: root.topbar_font; }
                TopBarButton {
                    x: 768px; y: row1_y; width: 60px; height: btn_h;
                    text: "Local";
                    active: root.time_mode == "Local";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => { root.time_mode_changed("Local"); }
                }
                TopBarButton {
                    x: 838px; y: row1_y; width: 50px; height: btn_h;
                    text: "UTC";
                    active: root.time_mode == "UTC";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => { root.time_mode_changed("UTC"); }
                }

                TopBarButton {
                    x: 898px; y: row1_y; width: 70px; height: btn_h;
                    text: "Stretch";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => { root.stretch_to_viewport(); }
                }
                TopBarButton {
                    x: 972px; y: row1_y; width: 98px; height: btn_h;
                    text: root.is_fullscreen ? "Exit Full" : "Fullscreen";
                    active: root.is_fullscreen;
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => {
                        root.is_fullscreen = !root.is_fullscreen;
                        root.fullscreen_toggle(root.is_fullscreen);
                    }
                }
                TopBarButton {
                    x: 1078px; y: row1_y; width: 120px; height: btn_h;
                    text: root.render_all_candles ? "Render: Full" : "Render: Cond";
                    active: root.render_all_candles;
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => {
                        root.render_all_candles = !root.render_all_candles;
                        root.render_mode_changed(root.render_all_candles);
                    }
                }
                TopBarButton {
                    x: 1206px; y: row1_y; width: 78px; height: btn_h;
                    text: root.feed_enabled ? "Feed: On" : "Feed: Off";
                    active: root.feed_enabled;
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => {
                        root.feed_enabled = !root.feed_enabled;
                        root.feed_enabled_changed(root.feed_enabled);
                    }
                }
                TopBarButton {
                    x: 1288px; y: row1_y; width: 78px; height: btn_h;
                    text: root.chart_enabled ? "Chart: On" : "Chart: Off";
                    active: root.chart_enabled;
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => {
                        root.chart_enabled = !root.chart_enabled;
                        root.chart_enabled_changed(root.chart_enabled);
                    }
                }

                TopBarButton {
                    x: 1350px; y: row1_y; width: 70px; height: btn_h;
                    text: root.chart_popout_open ? "Popout " : "Popout";
                    active: root.chart_popout_open;
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => {
                        if !root.chart_popout_open {
                            root.chart_popout_x = 80px;
                            root.chart_popout_y = 240px;
                            root.chart_popout_w = 760px;
                            root.chart_popout_h = 440px;
                        }
                        root.chart_popout_open = !root.chart_popout_open;
                    }
                }

                TopBarButton {
                    x: 1426px; y: row1_y; width: 48px; height: btn_h;
                    text: "Chart-";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => { root.inline_chart_height = Math.max(120px, root.inline_chart_height - 40px); }
                }
                TopBarButton {
                    x: 1480px; y: row1_y; width: 48px; height: btn_h;
                    text: "Chart+";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => { root.inline_chart_height = Math.min(600px, root.inline_chart_height + 40px); }
                }

                TopBarLabel {
                    x: 8px; y: row2_text_y;
                    text: "TF / Window:"; color: #aaaaaa;
                    label_font_size: font_main; label_font_family: root.topbar_font;
                }

                TopBarSelect {
                    x: 110px;
                    y: row2_y;
                    width: 90px;
                    height: btn_h;
                    model: root.tf_labels;
                    current_index <=> root.tf_selected;
                    font_size: font_main; font_family: root.topbar_font;
                    selected(value) => {
                        let idx =
                            value == "1s"   ? 0  :
                            value == "5s"   ? 1  :
                            value == "15s"  ? 2  :
                            value == "30s"  ? 3  :
                            value == "60s"  ? 4  :
                            value == "120s" ? 5  :
                            value == "180s" ? 6  :
                            value == "300s" ? 7  :
                            value == "10m"  ? 8  :
                            value == "15m"  ? 9  :
                            value == "30m"  ? 10 :
                            value == "1h"   ? 11 :
                            value == "2h"   ? 12 :
                            value == "4h"   ? 13 :
                            value == "8h"   ? 14 :
                            value == "1d"   ? 15 :
                            value == "1w"   ? 16 :
                            4; // fallback to 60s

                        root.tf_selected = idx;
                        root.candle_tf_changed(root.tf_seconds[idx]);
                    }
                }

                TopBarButton {
                    x: 230px; y: row2_y; width: 80px; height: btn_h;
                    text: "Win 60m";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => { root.candle_window_changed(60); }
                }
                TopBarButton {
                    x: 310px; y: row2_y; width: 90px; height: btn_h;
                    text: "Win 240m";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => { root.candle_window_changed(240); }
                }

                TopBarLabel { x: 400px; y: row2_text_y; text: "Price:"; color: #aaaaaa; label_font_size: font_main; label_font_family: root.topbar_font; }
                TopBarButton {
                    x: 450px; y: row2_y; width: 52px; height: btn_h;
                    text: "Bid";
                    active: root.candle_price_mode == "Bid";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => {
                        root.candle_price_mode = "Bid";
                        root.candle_price_mode_changed(root.candle_price_mode);
                    }
                }
                TopBarButton {
                    x: 506px; y: row2_y; width: 52px; height: btn_h;
                    text: "Mid";
                    active: root.candle_price_mode == "Mid";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => {
                        root.candle_price_mode = "Mid";
                        root.candle_price_mode_changed(root.candle_price_mode);
                    }
                }
                TopBarButton {
                    x: 562px; y: row2_y; width: 52px; height: btn_h;
                    text: "Ask";
                    active: root.candle_price_mode == "Ask";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => {
                        root.candle_price_mode = "Ask";
                        root.candle_price_mode_changed(root.candle_price_mode);
                    }
                }

                TopBarLabel { x: 630px; y: row2_text_y; text: "Panels:"; color: #aaaaaa; label_font_size: font_main; label_font_family: root.topbar_font; }
                TopBarCheck {
                    x: 690px; y: row2_y; width: 70px; height: btn_h;
                    text: "Depth";
                    checked <=> show_depth;
                    font_size: font_main; font_family: root.topbar_font;
                    box_size: 12px * root.topbar_scale;
                    toggled => { root.depth_panel_changed(self.checked); }
                }
                TopBarCheck {
                    x: 770px; y: row2_y; width: 74px; height: btn_h;
                    text: "Trades";
                    checked <=> show_trades;
                    font_size: font_main; font_family: root.topbar_font;
                    box_size: 12px * root.topbar_scale;
                    toggled => { root.trades_panel_changed(self.checked); }
                }
                TopBarCheck {
                    x: 860px; y: row2_y; width: 80px; height: btn_h;
                    text: "Volume";
                    checked <=> show_volume;
                    font_size: font_main; font_family: root.topbar_font;
                    box_size: 12px * root.topbar_scale;
                    toggled => { root.volume_panel_changed(self.checked); }
                }

                TopBarLabel { x: 940px; y: row2_text_y; text: "DOM depth:"; color: #aaaaaa; label_font_size: font_main; label_font_family: root.topbar_font; }

                Rectangle {
                    x: 1020px; y: slider_y; width: 180px; height: slider_h;
                    background: #202633; border-radius: 5px;

                    property <length> knob_x: (root.dom_depth_levels - 5) * (parent.width - 12px) / 45;

                    Rectangle { x: knob_x; y: -2px; width: 12px; height: parent.height + 4px; border-radius: 6px; background: #7070ff; }

                    TouchArea {
                        x: 0px; y: -4px; width: parent.width; height: parent.height + 8px;
                        property <bool> dragging;
                        property <int> last_sent;

                        pointer-event(event) => {
                            if event.kind == PointerEventKind.down {
                                dragging = true;
                                last_sent = root.dom_depth_levels;
                            } else if event.kind == PointerEventKind.up {
                                dragging = false;
                            } else if event.kind == PointerEventKind.move && dragging {
                                let pos = self.mouse-x;

                                if pos < 0px {
                                    let lvl = 5;
                                    if lvl != last_sent {
                                        last_sent = lvl;
                                        root.dom_depth_levels = lvl;
                                        root.dom_depth_changed(lvl);
                                    }
                                } else if pos > parent.width {
                                    let lvl = 50;
                                    if lvl != last_sent {
                                        last_sent = lvl;
                                        root.dom_depth_levels = lvl;
                                        root.dom_depth_changed(lvl);
                                    }
                                } else {
                                    let t = pos / parent.width;
                                    let lvl = 5 + Math.floor(t * 45.0);
                                    if lvl != last_sent {
                                        last_sent = lvl;
                                        root.dom_depth_levels = lvl;
                                        root.dom_depth_changed(lvl);
                                    }
                                }
                            }
                        }
                    }
                }

                TopBarLabel {
                    x: 1210px; y: row2_text_y;
                    text: dom_depth_levels + " lvls";
                    color: #cccccc;
                    label_font_size: font_small; label_font_family: root.topbar_font;
                }

                TopBarLabel { x: 1500px; y: row2_text_y; text: "Poll:"; color: #aaaaaa; label_font_size: font_main; label_font_family: root.topbar_font; }
                TopBarButton {
                    x: 1540px; y: row2_y; width: 26px; height: btn_h;
                    text: "-";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => { root.market_poll_adjust(-1); }
                }
                TopBarLabel {
                    x: 1570px; y: row2_text_y;
                    text: root.market_poll_secs + "s";
                    color: #cccccc;
                    label_font_size: font_small; label_font_family: root.topbar_font;
                }
                TopBarButton {
                    x: 1610px; y: row2_y; width: 26px; height: btn_h;
                    text: "+";
                    font_size: font_main; font_family: root.topbar_font;
                    clicked => { root.market_poll_adjust(1); }
                }

                TopBarLabel {
                    x: 1644px; y: row2_text_y;
                    text: "Zoom:";
                    color: #aaaaaa;
                    label_font_size: font_small; label_font_family: root.topbar_font;
                }
                TopBarButton {
                    x: 1644px; y: row2_y + (btn_h + 2px);
                    width: 36px; height: zoom_btn_h;
                    text: "X-";
                    font_size: font_small; font_family: root.topbar_font;
                    clicked => {
                        let old_z = Math.max(0.25, Math.min(8.0, root.chart_x_zoom));
                        let cx = root.chart_cursor_x;
                        let px = root.chart_pan_x;

                        let xw = 0.5 + (cx - 0.5 - px) / old_z;
                        let new_z = Math.max(0.25, old_z - 0.25);
                        root.chart_x_zoom = new_z;

                        let px2 = cx - 0.5 - (xw - 0.5) * new_z;
                        root.chart_pan_x = Math.max(-2.0, Math.min(2.0, px2));
                    }
                }
                TopBarButton {
                    x: 1684px; y: row2_y + (btn_h + 2px);
                    width: 36px; height: zoom_btn_h;
                    text: "X+";
                    font_size: font_small; font_family: root.topbar_font;
                    clicked => {
                        let old_z = Math.max(0.25, Math.min(8.0, root.chart_x_zoom));
                        let cx = root.chart_cursor_x;
                        let px = root.chart_pan_x;

                        let xw = 0.5 + (cx - 0.5 - px) / old_z;
                        let new_z = Math.min(8.0, old_z + 0.25);
                        root.chart_x_zoom = new_z;

                        let px2 = cx - 0.5 - (xw - 0.5) * new_z;
                        root.chart_pan_x = Math.max(-2.0, Math.min(2.0, px2));
                    }
                }
                TopBarButton {
                    x: 1724px; y: row2_y + (btn_h + 2px);
                    width: 36px; height: zoom_btn_h;
                    text: "Y-";
                    font_size: font_small; font_family: root.topbar_font;
                    clicked => {
                        let old_z = Math.max(0.25, Math.min(8.0, root.chart_y_zoom));
                        let cy = root.chart_cursor_y;
                        let py = root.chart_pan_y;
                        let mid = root.candle_midline;

                        let yw = mid + (cy - mid - py) / old_z;
                        let new_z = Math.max(0.25, old_z - 0.25);
                        root.chart_y_zoom = new_z;

                        let py2 = cy - mid - (yw - mid) * new_z;
                        root.chart_pan_y = Math.max(-1.0, Math.min(1.0, py2));
                    }
                }
                TopBarButton {
                    x: 1764px; y: row2_y + (btn_h + 2px);
                    width: 36px; height: zoom_btn_h;
                    text: "Y+";
                    font_size: font_small; font_family: root.topbar_font;
                    clicked => {
                        let old_z = Math.max(0.25, Math.min(8.0, root.chart_y_zoom));
                        let cy = root.chart_cursor_y;
                        let py = root.chart_pan_y;
                        let mid = root.candle_midline;

                        let yw = mid + (cy - mid - py) / old_z;
                        let new_z = Math.min(8.0, old_z + 0.25);
                        root.chart_y_zoom = new_z;

                        let py2 = cy - mid - (yw - mid) * new_z;
                        root.chart_pan_y = Math.max(-1.0, Math.min(1.0, py2));
                    }
                }

                TopBarLabel {
                    x: 1320px; y: row2_text_y;
                    text: (root.inline_chart_height / 1px) + "px";
                    color: #c0c0c0;
                    label_font_size: font_small; label_font_family: root.topbar_font;
                }
            }

            Rectangle {
                x: 0px;
                y: root.secondbar_y;
                width: parent.width;
                height: root.secondbar_h;
                background: #181b24;

                Button { x: 8px; y: 8px; text: "Buy";  clicked => { root.trade_side = "Buy"; } }
                Button { x: 80px; y: 8px; text: "Sell"; clicked => { root.trade_side = "Sell"; } }

                Button {
                    x: 152px; y: 8px;
                    text: "Send Order";
                    enabled: !root.trade_real_mode || root.trade_real_armed;
                    clicked => { root.send_order(); }
                }

                CheckBox {
                    x: 260px; y: 10px;
                    text: "REAL";
                    checked <=> root.trade_real_mode;
                    toggled => { root.trade_real_mode_toggled(self.checked); }
                }

                Text {
                    x: 340px; y: 12px;
                    text: "ARM:";
                    color: #cccccc;
                    visible: root.trade_real_mode;
                }

                LineEdit {
                    x: 380px; y: 8px;
                    width: 60px; height: 22px;
                    text <=> root.trade_real_arm_phrase;
                    visible: root.trade_real_mode;
                }

                Button {
                    x: 448px; y: 8px;
                    text: "ARM (60s)";
                    visible: root.trade_real_mode;
                    clicked => { root.arm_real_request(root.trade_real_arm_phrase); }
                }

                Button {
                    x: 540px; y: 8px;
                    text: "Disarm";
                    visible: root.trade_real_mode;
                    clicked => { root.disarm_real(); }
                }

                Text {
                    x: 620px; y: 12px;
                    text: root.trade_real_arm_status;
                    color: root.trade_real_armed ? #80ff80 : #ff8080;
                    visible: root.trade_real_mode;
                }

                Text {
                    x: 8px;
                    y: 40px;
                    text: "Side: " + trade_side + "  Size: " + trade_size + "  Lev: " + trade_leverage;
                    color: #aaaaaa;
                }

                CheckBox { x: 350px; y: 8px; text: "Bot auto trade"; checked <=> bot_auto_trade; }

                Button { x: 520px; y: 8px; text: "Deposit 100";  clicked => { root.deposit(100.0); } }
                Button { x: 620px; y: 8px; text: "Withdraw 100"; clicked => { root.withdraw(100.0); } }
                Button { x: 740px; y: 8px; text: "Reload data";  clicked => { root.reload_data(); } }
            }

            Rectangle {
                x: 0px;
                y: root.chart_top_y;
                width: parent.width * 0.5;
                height: parent.height - 320px;
                background: root.chart_view_mode == "Advanced" ? #0b0f17 : #11151d;

                property <length> header_h: 40px;
                property <length> gap: root.chart_sidebar_open ? 6px : 0px;
                property <length> chart_h: root.inline_chart_height;
                property <length> tools_w: root.chart_sidebar_open ? 140px : 0px;
                property <length> chart_x: 8px + tools_w + gap;
                property <length> chart_w: parent.width - chart_x - 8px;
                property <length> list_y: header_h + gap + chart_h + gap;
                property <length> toggle_w: 32px;
                property <length> header_text_x: 8px + toggle_w + 6px;
                property <length> price_w: 220px;
                property <length> price_x: parent.width - price_w - 8px;
                property <length> auto_x: parent.width - 180px;

                Text {
                    x: header_text_x;
                    y: 6px;
                    width: parent.width - price_w - 100px;
                    text:
                        "Candles  tf=" + candle_tf_secs
                        + "s  window=" + candle_window_minutes + "m"
                        + "   | X=" + chart_x_zoom + "  Y=" + chart_y_zoom
                        + "   | H=" + (root.inline_chart_height / 1px) + "px";
                    color: root.chart_view_mode == "Advanced" ? #f5e9ff : #ffffff;
                }

                Rectangle {
                    x: 8px;
                    y: 7px;
                    width: toggle_w;
                    height: 26px;
                    background: root.chart_view_mode == "Advanced" ? #12162a : #151b26;
                    border-width: 1px;
                    border-color: root.chart_view_mode == "Advanced" ? #343a52 : #2a3040;
                    border-radius: 3px;

                    Text {
                        x: 0px;
                        y: 0px;
                        width: parent.width;
                        height: parent.height;
                        text: root.chart_sidebar_open ? "<" : ">";
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        color: root.chart_view_mode == "Advanced" ? #f0d9ff : #dfe8ff;
                        font-size: 14px;
                    }

                    TouchArea {
                        x: 0px;
                        y: 0px;
                        width: parent.width;
                        height: parent.height;
                        clicked => { root.chart_sidebar_open = !root.chart_sidebar_open; }
                    }
                }

                Button {
                    x: auto_x;
                    y: 10px;
                    width: 72px;
                    height: 20px;
                    text: "Auto: center";
                    clicked => {
                        root.chart_pan_x = 0.0;
                        root.chart_pan_y = 0.0;
                        root.chart_x_zoom = 1.0;
                        root.chart_y_zoom = 1.0;
                    }
                }

                Rectangle {
                    x: 8px;
                    y: header_h + gap;
                    width: tools_w;
                    height: chart_h;
                    visible: root.chart_sidebar_open;
                    background: root.chart_view_mode == "Advanced" ? #101424 : #0c111a;
                    border-width: 1px;
                    border-color: root.chart_view_mode == "Advanced" ? #2c3146 : #1c2230;
                    border-radius: 3px;

                    property <length> tools_label_y: 84px;
                    property <length> tools_top: tools_label_y + 14px;
                    property <length> tools_row_h: 22px;
                    property <length> clear_y: tools_top + tools_row_h * root.draw_tools.length + 4px;
                    property <length> list_y: clear_y + 40px;

                    Text { x: 6px; y: 4px; text: "View"; color: root.chart_view_mode == "Advanced" ? #f0d9ff : #cfd6e6; font-size: 10px; }

                    Button {
                        x: 6px;
                        y: 18px;
                        width: parent.width - 12px;
                        height: 20px;
                        text: root.chart_view_mode == "Chart" ? "Chart View " : "Chart View";
                        clicked => {
                            root.chart_view_mode = "Chart";
                            root.chart_view_mode_changed(root.chart_view_mode);
                        }
                    }
                    Button {
                        x: 6px;
                        y: 40px;
                        width: parent.width - 12px;
                        height: 20px;
                        text: root.chart_view_mode == "Advanced" ? "Advanced " : "Advanced";
                        clicked => {
                            root.chart_view_mode = "Advanced";
                            root.chart_view_mode_changed(root.chart_view_mode);
                        }
                    }
                    Button {
                        x: 6px;
                        y: 62px;
                        width: parent.width - 12px;
                        height: 20px;
                        visible: root.chart_view_mode == "Advanced";
                        text: root.heatmap_enabled ? "Heatmap: On" : "Heatmap: Off";
                        clicked => {
                            root.heatmap_enabled = !root.heatmap_enabled;
                            root.heatmap_enabled_changed(root.heatmap_enabled);
                        }
                    }

                    Text { x: 6px; y: tools_label_y; text: "Tools"; color: root.chart_view_mode == "Advanced" ? #f0d9ff : #cfd6e6; font-size: 10px; }

                    for tool[idx] in root.draw_tools : Button {
                        x: 6px;
                        y: tools_top + (idx * tools_row_h);
                        width: parent.width - 12px;
                        height: 20px;
                        text: tool == root.draw_tool ? tool + " " : tool;
                        clicked => {
                            root.draw_tool = tool;
                            root.draw_tool_changed(tool);
                        }
                    }

                    Button {
                        x: 6px;
                        y: clear_y;
                        width: parent.width - 12px;
                        height: 20px;
                        text: "Clear All";
                        clicked => { root.drawing_clear_all(); }
                    }

                    Text { x: 6px; y: clear_y + 24px; text: "Drawings"; color: root.chart_view_mode == "Advanced" ? #f0d9ff : #cfd6e6; font-size: 10px; }

                    ListView {
                        x: 6px;
                        y: list_y;
                        width: parent.width - 12px;
                        height: parent.height - (list_y + 6px);

                        for d in root.drawings : Rectangle {
                            width: parent.width;
                            height: 18px;
                            visible: !d.is_preview;
                            background: d.selected ? #2b3244 : (root.chart_view_mode == "Advanced" ? #0f1322 : #121720);

                            Text {
                                x: 4px;
                                y: 2px;
                                text: d.kind + " #" + d.id;
                                color: d.selected ? #fff4c2 : #c9d4ea;
                                font-size: 9px;
                            }

                            Button {
                                x: parent.width - 20px;
                                y: 1px;
                                width: 18px;
                                height: 16px;
                                text: "X";
                                clicked => { root.drawing_delete(d.id); }
                            }

                            TouchArea {
                                x: 0px;
                                y: 0px;
                                width: parent.width - 24px;
                                height: parent.height;
                                clicked => { root.drawing_selected(d.id); }
                            }
                        }
                    }
                }

                CandleChart {
                    x: chart_x;
                    y: header_h + gap;
                    width: chart_w;
                    height: chart_h;

                    points <=> root.candle_points;
                    mid_line_y: root.candle_midline;
                    drawings: root.drawings;
                    draw_ticks: root.draw_ticks;
                    heatmap_cells: root.heatmap_cells;
                    heatmap_enabled: root.heatmap_enabled;
                    advanced_mode: root.chart_view_mode == "Advanced";
                    draw_tool: root.draw_tool;

                    x_zoom <=> root.chart_x_zoom;
                    y_zoom <=> root.chart_y_zoom;

                    pan_x <=> root.chart_pan_x;
                    pan_y <=> root.chart_pan_y;
                    cursor_x <=> root.chart_cursor_x;
                    cursor_y <=> root.chart_cursor_y;

                    show_volume_bars: root.show_volume;

                    draw_begin(x, y) => { root.draw_begin(x, y); }
                    draw_update(x, y) => { root.draw_update(x, y); }
                    draw_end(x, y) => { root.draw_end(x, y); }
                    draw_poly_sides_delta(delta) => { root.draw_poly_sides_delta(delta); }
                }

                // Price axis ticks (left)
                for t in root.price_ticks : Rectangle {
                    x: chart_x;
                    y: header_h + gap + chart_h * t.pos - 8px;
                    width: chart_w;
                    height: 16px;
                    background: #00000000;

                    Rectangle {
                        x: 0px;
                        y: 7px;
                        width: 6px;
                        height: 1px;
                        background: #4a5970;
                    }

                    Text {
                        x: 10px;
                        y: 0px;
                        text: t.label + (axis_price_unit == "" ? "" : (" " + axis_price_unit));
                        color: #9fd1ff;
                        font-size: 10px;
                    }
                }

                // Time axis ticks (bottom)
                for t in root.time_ticks : Rectangle {
                    x: chart_x + chart_w * t.pos;
                    y: header_h + gap + chart_h + 2px;
                    width: 1px;
                    height: 16px;
                    background: #4a5970;

                    Text {
                        x: -40px;
                        y: 4px;
                        width: 80px;
                        horizontal-alignment: center;
                        text: t.label;
                        color: #9fd1ff;
                        font-size: 10px;
                    }
                }

                ListView {
                    x: 8px;
                    y: list_y;
                    width: parent.width - 16px;
                    height: parent.height - (list_y + 8px);

                    for c in root.candles : Text {
                        text: c.ts + "  O:" + c.open + " H:" + c.high + " L:" + c.low + " C:" + c.close + " V:" + c.volume;
                        color: #d0d0d0;
                    }
                }
            }

            Rectangle {
                x: parent.width * 0.5;
                y: root.chart_top_y;
                width: parent.width * 0.5;
                height: parent.height - 320px;
                background: root.chart_view_mode == "Advanced" ? #141726 : #181b24;

                Rectangle {
                    x: 4px;
                    y: 4px;
                    width: parent.width - 8px;
                    height: 110px;
                    background: #10131a;
                    visible: root.show_trades;

                    Text { x: 4px; y: 4px; text: "Recent trades"; color: #ffffff; }

                    ListView {
                        x: 4px;
                        y: 22px;
                        width: parent.width - 8px;
                        height: parent.height - 26px;

                        for t in root.recent_trades : Rectangle {
                            width: parent.width;
                            height: 18px;
                            background: t.is_buy ? #102b19 : #2b1418;

                            Text {
                                x: 2px;
                                y: 1px;
                                text: t.ts + "  " + t.side + "  " + t.size;
                                color: t.is_buy ? #80ff80 : #ff8080;
                            }
                        }
                    }
                }

                Rectangle {
                    x: 4px;
                    y: 120px;
                    width: parent.width - 8px;
                    height: 130px;
                    background: #10131a;

                    Text { x: 4px; y: 4px; text: "Receipts"; color: #ffffff; }

                    ListView {
                        x: 4px;
                        y: 22px;
                        width: parent.width - 8px;
                        height: parent.height - 26px;

                        for r in root.receipts : Text {
                            text: r.ts + "  " + r.ticker + "  " + r.side + " " + r.kind + " " + r.size + " " + r.status;
                            color: r.status == "ok" ? #80ff80 : (r.status == "fail" ? #ff8080 : #c0c0c0);
                        }
                    }
                }

                Rectangle {
                    x: 4px;
                    y: 254px;
                    width: parent.width - 8px;
                    height: parent.height - 262px;
                    background: #10131a;

                    Text { x: 4px; y: 4px; text: "Bot: " + bot_signal + "  size=" + bot_size; color: #ffffff; }
                    Text { x: 4px; y: 24px; text: "Comment: " + bot_comment; color: #cccccc; }

                    TextEdit {
                        x: 4px;
                        y: 44px;
                        width: parent.width - 8px;
                        height: parent.height - 120px;
                        text <=> root.script_text;
                    }

                    Button { x: 4px; y: parent.height - 68px; text: "Run Script"; clicked => { root.run_script(); } }
                    Text { x: 4px; y: parent.height - 44px; text: script_error; color: #ff8080; }
                    Text { x: 4px; y: parent.height - 24px; text: order_message; color: #80ff80; }
                }
            }

            OrderbookPanel {
                x <=> root.orderbook_x;
                y <=> root.orderbook_y;
                width: 360px;
                height: 260px;
                title: "Orderbook";
                bids <=> root.bids;
                asks <=> root.asks;
                mid: root.mid_price;
                spread: root.spread;
                spread_main: root.spread_main;
                spread_pad: root.spread_pad;
                visible: root.show_depth || root.show_ladders;
            }

            SettingsPanel {
                x <=> root.settings_x;
                y <=> root.settings_y;
                width: 380px;
                height: 320px;

                wallet_address <=> root.settings_wallet_address;
                wallet_status  <=> root.settings_wallet_status;

                network      <=> root.settings_network;
                rpc_endpoint <=> root.settings_rpc_endpoint;

                auto_sign           <=> root.settings_auto_sign;
                session_ttl_minutes <=> root.settings_session_ttl_minutes;
                signer_status       <=> root.settings_signer_status;

                last_error <=> root.settings_last_error;

                connect_wallet => { root.settings_connect_wallet(); }
                disconnect_wallet => { root.settings_disconnect_wallet(); }
                refresh_status => { root.settings_refresh_status(); }

                select_network(net) => { root.settings_select_network(net); }
                apply_rpc(endpoint) => { root.settings_apply_rpc(endpoint); }

                toggle_auto_sign(enabled) => { root.settings_toggle_auto_sign(enabled); }
                create_session(ttl_minutes) => { root.settings_create_session(ttl_minutes); }
                revoke_session => { root.settings_revoke_session(); }
            }

            MicroDepthPanel {
                x: parent.width - 260px;
                y: 48px;
                width: 240px;
                height: 72px;
                bids <=> root.bids;
                asks <=> root.asks;
                imbalance: root.imbalance;
                visible: root.show_depth;
            }

            Rectangle {
                property <length> chart_left: 0px;
                property <length> chart_top: 244px;
                property <length> chart_w: parent.width * 0.5;
                property <length> price_w: 240px;
                property <length> price_h: 36px;
                property <length> meta_w: 220px;
                property <length> meta_h: 74px;

                Rectangle {
                    x: -meta_w - 12px;
                    y: -4px;
                    width: meta_w;
                    height: meta_h;
                    background: root.chart_view_mode == "Advanced" ? #0f1324cc : #0e1422cc;
                    border-width: 1px;
                    border-color: root.chart_view_mode == "Advanced" ? #2f3550 : #273042;
                    border-radius: 4px;

                    Text {
                        x: 8px;
                        y: 6px;
                        text: "Mark:";
                        color: #b8c5ff;
                        font-size: 20px;
                    }
                    ZeroPadText {
                        main: root.mark_price_main == "" ? "--" : root.mark_price_main;
                        pad: root.mark_price_main == "" ? "" : root.mark_price_pad;
                        main_color: #e8f6ff;
                        pad_color: #7aa8ff;
                        font_size: 20px;
                        x: 70px;
                        y: 6px;
                    }

                    Text {
                        x: 8px;
                        y: 28px;
                        text: "Oracle:";
                        color: #b8c5ff;
                        font-size: 20px;
                    }
                    ZeroPadText {
                        main: root.oracle_price_main == "" ? "--" : root.oracle_price_main;
                        pad: root.oracle_price_main == "" ? "" : root.oracle_price_pad;
                        main_color: #e8f6ff;
                        pad_color: #7aa8ff;
                        font_size: 20px;
                        x: 70px;
                        y: 28px;
                    }

                    Text {
                        x: 8px;
                        y: 50px;
                        text: "Last:";
                        color: #b8c5ff;
                        font-size: 20px;
                    }
                    ZeroPadText {
                        main: root.last_price_main == "" ? "--" : root.last_price_main;
                        pad: root.last_price_main == "" ? "" : root.last_price_pad;
                        main_color: #e8f6ff;
                        pad_color: #7aa8ff;
                        font_size: 20px;
                        x: 70px;
                        y: 50px;
                    }
                }

                x: chart_left + chart_w - price_w - 12px;
                y: chart_top + 4px;
                width: price_w;
                height: price_h;
                background: root.chart_view_mode == "Advanced" ? #0f1324cc : #0e1422cc;
                border-width: 1px;
                border-color: root.chart_view_mode == "Advanced" ? #2f3550 : #273042;
                border-radius: 4px;
                visible: true;

                ZeroPadText {
                    main: root.current_price_main == "" ? "--" : root.current_price_main;
                    pad: root.current_price_main == "" ? "" : root.current_price_pad;
                    main_color: root.chart_view_mode == "Advanced" ? #ffdaff : #e8f6ff;
                    pad_color: #7aa8ff;
                    font_size: 30px;
                    x: parent.width - self.width - 6px;
                    y: (parent.height - self.height) / 2;
                }
            }
        Rectangle {
            x: 70px;
            y: root.topbar_y + root.topbar_h;
            width: 260px;
            height: 280px;
            background: #0f1320;
            border-radius: 4px;
            border-width: 1px;
            border-color: #2a3346;
            visible: root.tickers_dropdown_open;

            Text { x: 8px; y: 6px; text: "Tickers"; color: #c7d2ff; font-size: 12px; }

            ListView {
                x: 6px;
                y: 26px;
                width: parent.width - 12px;
                height: parent.height - 32px;

                for row in root.ticker_feed_rows : Rectangle {
                    width: parent.width;
                    height: 22px;
                    background: row.ticker == root.current_ticker
                        ? (row.active ? #1b2438 : #242835)
                        : (row.active ? #111725 : #0b0f1a);

                    Text {
                        x: 6px;
                        y: 3px;
                        text: row.ticker;
                        color: row.active ? #d6dcff : #6f778a;
                        font-size: 12px;
                    }

                    Button {
                        x: parent.width - 74px;
                        y: 2px;
                        width: 70px;
                        height: 18px;
                        text: row.feed_on ? "Feed: On" : "Feed: Off";
                        enabled: row.active;
                        clicked => { root.ticker_feed_toggled(row.ticker, !row.feed_on); }
                    }
                    Text {
                        x: parent.width - 150px;
                        y: 4px;
                        width: 70px;
                        text: "Inactive";
                        color: #6f778a;
                        font-size: 10px;
                        horizontal-alignment: right;
                        visible: !row.active;
                    }

                    TouchArea {
                        x: 0px;
                        y: 0px;
                        width: parent.width - 78px;
                        height: parent.height;
                        clicked => {
                            if row.active {
                                root.ticker_input = row.ticker;
                                root.ticker_changed(row.ticker);
                                root.tickers_dropdown_open = false;
                            }
                        }
                    }
                }
            }
        }
        }

        // Horizontal scrollbar
        hscroll := Rectangle {
            x: 2px;
            y: parent.height - 12px;
            width: parent.width - 14px;
            height: 10px;
            background: #202633;
            border-radius: 5px;
            visible: max_scroll_x > 0.0;

            property <float> bar_w: self.width / 1px;
            property <float> knob_w: Math.max(30.0, bar_w * (viewport_w_px / content_w_px));
            property <float> t: max_scroll_x <= 0.0 ? 0.0 : (sx / max_scroll_x);
            property <float> knob_x: t * Math.max(0.0, bar_w - knob_w);

            Rectangle {
                x: knob_x * 1px;
                y: -1px;
                width: knob_w * 1px;
                height: parent.height + 2px;
                background: #7070ff;
                border-radius: 6px;

                TouchArea {
                    x: 0px; y: -6px;
                    width: parent.width; height: parent.height + 12px;

                    property <bool> dragging;

                    pointer-event(event) => {
                        if event.kind == PointerEventKind.down {
                            dragging = true;
                        } else if event.kind == PointerEventKind.up {
                            dragging = false;
                        } else if event.kind == PointerEventKind.move && dragging {
                            let mx = self.mouse-x / 1px;
                            let bw = hscroll.bar_w;
                            let kw = hscroll.knob_w;

                            let nx = Math.max(0.0, Math.min(bw - kw, mx - kw * 0.5));
                            let nt = (bw - kw) <= 0.0 ? 0.0 : (nx / (bw - kw));

                            root.ui_scroll_x_px = nt * viewport.max_scroll_x;
                        }
                    }
                }
            }
        }

        // Vertical scrollbar
        vscroll := Rectangle {
            x: parent.width - 12px;
            y: 2px;
            width: 10px;
            height: parent.height - 14px;
            background: #202633;
            border-radius: 5px;
            visible: max_scroll_y > 0.0;

            property <float> bar_h: self.height / 1px;
            property <float> knob_h: Math.max(30.0, bar_h * (viewport_h_px / content_h_px));
            property <float> t: max_scroll_y <= 0.0 ? 0.0 : (sy / max_scroll_y);
            property <float> knob_y: t * Math.max(0.0, bar_h - knob_h);

            Rectangle {
                x: -1px;
                y: knob_y * 1px;
                width: parent.width + 2px;
                height: knob_h * 1px;
                background: #7070ff;
                border-radius: 6px;

                TouchArea {
                    x: -6px; y: 0px;
                    width: parent.width + 12px; height: parent.height;

                    property <bool> dragging;

                    pointer-event(event) => {
                        if event.kind == PointerEventKind.down {
                            dragging = true;
                        } else if event.kind == PointerEventKind.up {
                            dragging = false;
                        } else if event.kind == PointerEventKind.move && dragging {
                            let my = self.mouse-y / 1px;
                            let bh = vscroll.bar_h;
                            let kh = vscroll.knob_h;

                            let ny = Math.max(0.0, Math.min(bh - kh, my - kh * 0.5));
                            let nt = (bh - kh) <= 0.0 ? 0.0 : (ny / (bh - kh));

                            root.ui_scroll_y_px = nt * viewport.max_scroll_y;
                        }
                    }
                }
            }
        }

        // Popout drawn LAST so it sits on top, and NOT scrolled
        ChartPopoutPanel {
            open <=> root.chart_popout_open;
            px <=> root.chart_popout_x;
            py <=> root.chart_popout_y;
            pw <=> root.chart_popout_w;
            ph <=> root.chart_popout_h;

            title: "Chart Popout (wheel: zoom, drag: pan)";

            points <=> root.candle_points;
            mid_line_y: root.candle_midline;
            drawings <=> root.drawings;
            draw_ticks <=> root.draw_ticks;
            heatmap_cells <=> root.heatmap_cells;
            heatmap_enabled: root.heatmap_enabled;
            advanced_mode: root.chart_view_mode == "Advanced";
            draw_tool: root.draw_tool;

            x_zoom <=> root.chart_x_zoom;
            y_zoom <=> root.chart_y_zoom;
            pan_x  <=> root.chart_pan_x;
            pan_y  <=> root.chart_pan_y;
            cursor_x <=> root.chart_cursor_x;
            cursor_y <=> root.chart_cursor_y;

            draw_begin(x, y) => { root.draw_begin(x, y); }
            draw_update(x, y) => { root.draw_update(x, y); }
            draw_end(x, y) => { root.draw_end(x, y); }
            draw_poly_sides_delta(delta) => { root.draw_poly_sides_delta(delta); }
        }
    }
}
